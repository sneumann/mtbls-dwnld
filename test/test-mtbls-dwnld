#!/bin/bash
# vi: fdm=marker

# Constants {{{1
################################################################

PROG_NAME=$(basename $0)
PROG_PATH=$(dirname $0)
RES_PATH=$PROG_PATH/res
OUTPUT_PATH=$PROG_PATH/outputs
TEST_MTBLS_DWNLD_ASPERA_PUBLIC_TOKEN=Xz68YfDe
[[ -z $(which ascp) ]] || ASPERA_CLIENT=ascp
WGET=wget

[[ -d $OUTPUT_PATH ]] || mkdir $OUTPUT_PATH

# Error {{{1
################################################################

function error {

	local msg=$1

	echo "ERROR: $msg" >&2

	exit 1
}

# Test downloading {{{1
################################################################

function test_downloading {

	method=$1
	token=$2
	study_path=$3
	private=$4
	study=$(basename $study_path)

	# Remove previously downloaded directory
	rm -rf $study

	# Download
	options=-gM
	[[ $method == $ASPERA_CLIENT ]] && options+=" -a"
	[[ -n $private ]] && options+=" -p"
	[[ -n $token ]] && options+=" -t $token"
	$PROG_PATH/../mtbls-dwnld $options $study_path || error "Download of $study failed !"

	# Test downloaded directory
	[[ -d $study ]] || error "Download of study $study with $method method failed !"
	[[ -f $study/i_Investigation.txt ]] || error "Download of study $study with $method method failed ! No investigation file found."
}

# Test wget public download {{{1
################################################################

function test_wget_public_download {

	# Loop on small public studies
	for study in MTBLS1 MTBLS2 MTBLS30 MTBLS338 ; do
		test_downloading $WGET "" /studies/public/$study
	done
}

# Test aspera public download {{{1
################################################################

function test_aspera_public_download {

	study=MTBLS1

	test_downloading $ASPERA_CLIENT "$TEST_MTBLS_DWNLD_ASPERA_PUBLIC_TOKEN" /studies/public/$study
}

# Test private download {{{1
################################################################

function test_private_download {

	method=$1
	study=$2

	# Get path
	path=TEST_MTBLS_DWNLD_${method}_${study}_PRIVATE_PATH
	path=$(echo $path | tr '[:lower:]' '[:upper:]')
	if [[ -z "${!path}" ]] ; then
		echo "No path to test private download of $study with method $method. Please set environment variable $path." >&2
		return
	fi

	# Get token
	token=TEST_MTBLS_DWNLD_${method}_${study}_PRIVATE_TOKEN
	token=$(echo $token | tr '[:lower:]' '[:upper:]')
	if [[ -z "${!token}" ]] ; then
		echo "No token to test private download of $study with method $method. Please set environment variable $token." >&2
		return
	fi

	test_downloading $method "${!token}" "${!path}" 1
}

# Test wget private download {{{1
################################################################

function test_wget_private_download {
	test_private_download $WGET MTBLS353
}

# Test aspera private download {{{1
################################################################

function test_aspera_private_download {
	test_private_download $ASPERA_CLIENT MTBLS1
}

# Test W4M conversion {{{1
################################################################

function test_w4m_conversion {

	study=MTBLS404

	# Remove previously downloaded directory
	rm -rf $study

	output_sample_file=$OUTPUT_PATH/$study-w4m-sample-metadata.tsv
	output_variable_file=$OUTPUT_PATH/$study-w4m-variable-metadata.tsv
	output_matrix_file=$OUTPUT_PATH/$study-w4m-sample-variable-matrix.tsv

	# Download
	$PROG_PATH/../mtbls-dwnld -gMw -s "$output_sample_file" -v "$output_variable_file" -m "$output_matrix_file" /studies/public/$study || error "Download failed !"

	# Compare
	for f in sample-metadata variable-metadata sample-variable-matrix ; do
		ref_file="$RES_PATH/$study/$study-w4m-$f.tsv"
		file="$OUTPUT_PATH/$study-w4m-$f.tsv"
		diff -q "$ref_file" "$file" || error "Output file \"$file\" differs from reference file \"$ref_file\"."
	done
}
# Test W4M conversion of private study {{{1
################################################################

function test_w4m_conversion_private {

	study=MTBLS353
	token=$TEST_MTBLS_DWNLD_WGET_MTBLS353_PRIVATE_TOKEN

	if [[ -z $token ]] ; then
		echo "No token provided for private study $study. Cannot test download and conversion of study $study." >&2
		return
	fi

	# Remove previously downloaded directory
	rm -rf $study

	output_sample_file=$OUTPUT_PATH/$study-w4m-sample-metadata.tsv
	output_variable_file=$OUTPUT_PATH/$study-w4m-variable-metadata.tsv
	output_matrix_file=$OUTPUT_PATH/$study-w4m-sample-variable-matrix.tsv

	# Download
	$PROG_PATH/../mtbls-dwnld -pgMw -t "$token" -s "$output_sample_file" -v "$output_variable_file" -m "$output_matrix_file" $study || error "Download failed !"
}

# Test W4M conversion with NA filtering {{{1
################################################################

function test_w4m_na_filtering {

	study=MTBLS404

	# Remove previously downloaded directory
	rm -rf $study

	output_sample_file=$OUTPUT_PATH/$study-w4m-sample-metadata-na-filtering.tsv
	output_variable_file=$OUTPUT_PATH/$study-w4m-variable-metadata-na-filtering.tsv
	output_matrix_file=$OUTPUT_PATH/$study-w4m-sample-variable-matrix-na-filtering.tsv

	# Download
	$PROG_PATH/../mtbls-dwnld -gMw -S 'Characteristics[gender]' -V 'mass_to_charge' -s "$output_sample_file" -v "$output_variable_file" -m "$output_matrix_file" /studies/public/$study || error "Download failed !"

	# Compare
	for f in sample-metadata-na-filtering variable-metadata-na-filtering sample-variable-matrix-na-filtering ; do
		ref_file="$RES_PATH/$study/$study-w4m-$f.tsv"
		file="$OUTPUT_PATH/$study-w4m-$f.tsv"
		diff -q "$ref_file" "$file" || error "Output file \"$file\" differs from reference file \"$ref_file\"."
	done
}

# Test W4M conversion with choice of a assay file {{{1
################################################################

function test_w4m_assay_file {

	study=MTBLS30
	study_path="$RES_PATH/$study"

	for assay in "a_york_src_GCMS_metabolomics_metabolite profiling_mass spectrometry.txt" "a_york_src_LCMS_metabolomics_metabolite profiling_mass spectrometry.txt" ; do

		# Remove previously downloaded directory
		rm -rf $study

		output_sample_file=$OUTPUT_PATH/$study-w4m-sample-metadata-$assay.tsv
		output_variable_file=$OUTPUT_PATH/$study-w4m-variable-metadata-$assay.tsv
		output_matrix_file=$OUTPUT_PATH/$study-w4m-sample-variable-matrix-$assay.tsv

		# Download
		$PROG_PATH/../mtbls-dwnld -gMw -f "$assay" -s "$output_sample_file" -v "$output_variable_file" -m "$output_matrix_file" /studies/public/$study || error "Download failed !"

		# Check output files
		for f in sample-metadata variable-metadata sample-variable-matrix ; do
			ref_file="$study_path/$study-w4m-$f-$assay.tsv"
			output_file="$OUTPUT_PATH/$study-w4m-$f-$assay.tsv"
			[[ -f $ref_file ]] || error "Reference file \"$ref_file\" does not exist."
			[[ -f $output_file ]] || error "Output file \"$output_file\" does not exist."
			diff -q "$ref_file" "$output_file" || error "Output file \"$output_file\" differs from reference file \"$ref_file\"."
		done
	done
}

# MAIN {{{1
################################################################


# List methods
methods="$WGET $ASPERA_CLIENT"
if [[ -z $ASPERA_CLIENT ]] ; then
	echo "ascp not installed => no tests with Aspera download server." >&2
fi

test_w4m_conversion_private
test_wget_public_download
[[ -z $ASPERA_CLIENT ]] || test_aspera_public_download
test_wget_private_download
[[ -z $ASPERA_CLIENT ]] || test_aspera_private_download
test_w4m_conversion
test_w4m_na_filtering
test_w4m_assay_file
