<tool id="mtbls-dwnld" name="Metabolights downloader" version="1.3.0">

	<description>Import ISA TAB data format from public and private MetaboLights studies</description>

	<code file="list-assays.py"/>

	<!--=======
	= COMMAND =
	========-->

	<command><![CDATA[
		## @@@BEGIN_CHEETAH@@@

		$__tool_directory__/mtbls-dwnld

		#if $token:
			-t "$token"
		#end if
		#if $type == 'private':
			-p
		#end if
		#if $downloader == 'aspera':
			-a
		#end if

		## Download only the metadata
		#if $metadata:
			-M
		#end if

		## HTML output
		-H "$html_output"
		-o "$html_output.files_path"

		## W4M output
		-w

			## All assays output
			-A
			-d w4m

			## Single assay output
			#if $assay.assay:
				-f "$assay.assay"
			#end if
			-s "$w4m_sample_metadata"
			-v "$w4m_variable_metadata"
			-m "$w4m_data_matrix"

			## Filtering
			#if $sample_na_filtering:
				-S "$sample_na_filtering"
			#end if
			#if $variable_na_filtering:
				-V "$variable_na_filtering"
			#end if

		## Study to output
		"$study"

		## @@@END_CHEETAH@@@
	]]></command>

	<!--======
	= INPUTS =
	=======-->

	<inputs>

		<!-- Public or private -->
		<param name="type" label="Study type" type="select">
			<option value="public">Public</option>
			<option value="private">Private</option>
		</param>

		<!-- Downloader -->
		<param name="downloader" label="Downloader" type="select">
			<option value="wget">wget</option>
			<option value="aspera">Aspera</option>
		</param>

		<!-- Metadata -->
		<param name="metadata" label="Download only the metadata" type="boolean" checked="true" truevalue="1" falsevalue="0"/>

		<!-- Study name -->
		<param name="study" type="text" label="Study name" help="Study name in the form MTBLSXXXX. For downloading a private study with Aspera client, set to the full path of the study." refresh_on_change="true"/>

		<!-- Token -->
		<param name="token" type="text" optional="true" format="txt" label="Token"  help="Token is required for private study or for downloading with Aspera client."/>

		<!-- Assay -->
		<conditional name="assay">

			<param name="import" type="select" label="Assay to import" help="One of the assays will be set to fixed dataset names, so you can use it in workflow. Select here the way to specify this assay. By default this is will be the first assay found." refresh_on_change="true">
				<option value="text">Input name</option>
				<option value="select">Select from list</option>
			</param>

			<when value="text">
				<param name="assay" type="text" size="256" value="" help="Type here the name of the assay file you want to extract."/>
			</when>
			<when value="select">
				<param name="assay" type="select" optional="true" dynamic_options="get_assay_files(study = study)" label="Assay file" help="Choose here the assay file you want to extract."/>
			</when>
		</conditional>

		<param name="sample_na_filtering" type="text" label="Sample metadata columns NA filtering" help="The rows that contain NA value in the specified columns will be filtered out. Column names must be separated by commas."/>
		<param name="variable_na_filtering" type="text" label="Variable metadata columns NA filtering" help="The rows that contain NA value in the specified columns will be filtered out. Column names must be separated by commas."/>
	</inputs>

    <outputs>
<!-- DEBUG galaxy.datatypes.registry WARNING 2016-10-26 07:19:30,511 unknown mimetype in data factory isatab
 -->
        <data name="html_output" label="ISA-Tab of ${study}.html" format="html"/>

		<data format="tsv" name="w4m_all_assays">
			<discover_datasets pattern="__designation_and_ext__" directory="w4m" visible="true"/>
		</data>

		<!--		<collection name="w4m_output" type="list" label="Output compatible with W4M tools">
			    <discover_datasets pattern="__name_and_ext__" directory="w4m" format="tsv"/>
			</collection>
-->

		<data name="w4m_variable_metadata" label="W4M variable metadata.tsv" format="tabular"/>
        <data name="w4m_sample_metadata" label="W4M sample metadata.tsv" format="tabular"/>
        <data name="w4m_data_matrix" label="W4M data matrix.tsv" format="tabular"/>

        <!-- Using new type by inheriting only from HTML, no class definition -->
   		<!--     <data name="isatab_output_inherit_html" label="ISA-Tab of $study - inherit HTML.isatabhtml" format="isatabhtml"/> -->
        <!-- Put the following line inside "config/datatypes_conf.xml":
	  <datatype extension="isatabhtml" type="galaxy.datatypes.text:Html" subclass="True"/>
-->

		<!-- Using new composite type, creating new class. -->
        <!-- <data name="isatab_output_composite" label="ISA-Tab of $study - composite.isatab" format="isatab"/> -->
        <!-- Put the following line inside "config/datatypes_conf.xml":
	  				<datatype extension="isatab" type="galaxy.datatypes.isatab:ISATab"/>
			Then make a symbolic link to "isatab.py" inside "lib/galaxy/datatypes".
		-->
    </outputs>

	<!-- TESTS {{{1 -->
	<tests>
		<test>
			<param name="study" value="MTBLS30"/>
			<param name="assay" value="a_york_src_GCMS_metabolomics_metabolite profiling_mass spectrometry.txt"/>
			<output name="html_output" file="mtbls30.html"/>
			<output name="w4m_sample_metadata" file="mtbls30-gcms-w4m-sample-metadata.tsv"/>
			<output name="w4m_variable_metadata" file="mtbls30-gcms-w4m-variable-metadata.tsv"/>
			<output name="w4m_data_matrix" file="mtbls30-gcms-w4m-sample-variable-matrix.tsv"/>
		</test>
		<test>
			<param name="study" value="MTBLS30"/>
			<param name="assay" value="a_york_src_LCMS_metabolomics_metabolite profiling_mass spectrometry.txt"/>
			<output name="html_output" file="mtbls30.html"/>
			<output name="w4m_sample_metadata" file="mtbls30-lcms-w4m-sample-metadata.tsv"/>
			<output name="w4m_variable_metadata" file="mtbls30-lcms-w4m-variable-metadata.tsv"/>
			<output name="w4m_data_matrix" file="mtbls30-lcms-w4m-sample-variable-matrix.tsv"/>
		</test>
	</tests>

    <help><![CDATA[
**Overview**
A tool to transfer MetaboLights studies. 
    ]]></help>

	<!-- CITATIONS {{{1 -->
    <citations>
        <citation type="doi">10.1002/0471250953.bi1413s53</citation>
        <citation type="doi">10.1007/s11306-015-0879-3</citation>
        <citation type="doi">10.1038/ng.1054</citation>
    </citations>
</tool>
